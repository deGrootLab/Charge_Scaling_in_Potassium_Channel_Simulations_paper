from pathlib import Path
import numpy as np

def scale_charge(lines, x0, x1, K_charge, res_keywords):
    k0 =  5*K_charge - 4  # charges at lambda = 1.0
    k1 = -5*K_charge + 5  # charges at lambda = 0.8
    new_charge  = k0 * x0 + k1 * x1
    for i in range(len(lines)):
        if res_keywords in lines[i]:
            for at in range(len(new_charge)):
                lines[i + at] = lines[i + at][0:46] +  "  %14.8f "%new_charge[at] + lines[i + at][57:]


def write_itp(pmf_dir, K_charge, original_itp):
    with open(original_itp, "r") as f:
        lines = f.readlines()
        ##############
        # ASP 21 68 74
        ##############
        x0 = np.array([
            -0.51630,
             0.29360,
             0.03810,
             0.08800,
            -0.03030,
            -0.01220,
            -0.01220,
             0.79940,
            -0.80140,
            -0.80140,
             0.53660,
            -0.58190
        ]) # original charge in ff
        x1 = np.array([
            -0.49618 ,
             0.28926 ,
             0.0373  ,
             0.08768 ,
             -0.03056,
             0       ,  
             0       ,  
             0.76876 ,
            -0.71295 ,
            -0.71295 ,
             0.54874 ,
            -0.5791  , 
        ])
        scale_charge(lines, x0, x1, K_charge, res_keywords="ASP      N")
        
        ##############
        # LYS 22 77 97
        ##############
        x0 = np.array([
            -0.34790,
             0.27470,
            -0.24000,
             0.14260,
            -0.00940,
             0.03620,
             0.03620,
             0.01870,
             0.01030,
             0.01030,
            -0.04790,
             0.06210,
             0.06210,
            -0.01430,
             0.11350,
             0.11350,
            -0.38540,
             0.34000,
             0.34000,
             0.34000,
             0.73410,
            -0.58940,]) # original charge in ff
        x1 = np.array([
            -0.36146 ,
            0.27414  ,
            -0.206412,
            0.13396  ,
            -0.01721 ,
            0.03576  ,
            0.03576  ,
            0.028184 ,
            0.010322 ,
            0.010322 ,
            -0.045856,
            0.05199  ,
            0.05199  ,
            0.053768 ,
            0.084084 ,
            0.084084 ,
            -0.515482,
            0.323472 ,
            0.323472 ,
            0.323472 ,
            0.70674  ,
            -0.5851  ,
        ])
        scale_charge(lines, x0, x1, K_charge, res_keywords="LYS      N")

        ##############
        # GLU 23 46
        ##############
        x0 = np.array([
            -0.51630,
             0.29360,
             0.03970,
             0.11050,
             0.05600,
            -0.01730,
            -0.01730,
             0.01360,
            -0.04250,
            -0.04250,
             0.80540,
            -0.81880,
            -0.81880,
             0.53660,
            -0.58190,
        ]) # original charge in ff
        x1 = np.array([
            -0.49618,
             0.28926,
             0.03466,
             0.10398,
             0.04338,
            -0.00872,
            -0.00872,
             0.00740,
            -0.02540,
            -0.02540,
             0.78034,
            -0.73212,
            -0.73212,
             0.54874,
            -0.57910,
        ])
        scale_charge(lines, x0, x1, K_charge, res_keywords="GLU      N")

        ##############
        # ARG 49
        ##############
        x0 = np.array([
            -0.34790,
             0.27470,
            -0.26370,
             0.15600,
            -0.00070,
             0.03270,
             0.03270,
             0.03900,
             0.02850,
             0.02850,
             0.04860,
             0.06870,
             0.06870,
            -0.52950,
             0.34560,
             0.80760,
            -0.86270,
             0.44780,
             0.44780,
            -0.86270,
             0.44780,
             0.44780,
             0.73410,
            -0.58940,]) # original charge in ff
        x1 = np.array([
            -0.3614600,
             0.2741400,
            -0.2001816,
             0.1421220,
            -0.0919632,
             0.0571836,
             0.0571836,
             0.0503674,
             0.0281746,
             0.0281746,
             0.0921504,
             0.0544962,
             0.0544962,
            -0.5964158,
             0.3472888,
             0.8526032,
            -0.8906260,
             0.4178130,
             0.4178130,
            -0.8906260,
             0.4178130,
             0.4178130,
             0.7067400,
            -0.5851000,

        ])
        scale_charge(lines, x0, x1, K_charge, res_keywords="ARG      N")

        with open(pmf_dir/"topol_Protein_chain_A.itp", "w") as f:
            f.writelines(lines)

P_list = [
("1" , .99),
("2" , .98),
("3" , .97),
("4" , .96),
("5" , .95),
("6" , .94),
("7" , .93),
("8" , .92),
("9" , .91),
("10", .90),
("11", .89),
("12", .88),
("13", .87),
("14", .86),
("15", .85),
("16", .84),
("17", .83),
("18", .82),
("19", .81),
("20", .80),
("21", .79),
("22", .78),
("23", .77),
("24", .76),
("25", .75),
("26", .74),
("27", .73),
("28", .72),
("29", .71),
("30", .70),
("31", .69),
("32", .68),
("33", .67),
("34", .66),
("35", .65),
    ]
for folder, charge in P_list:
    pmf_dir = Path(folder)
    write_itp(pmf_dir, charge, Path("tmp/topol_Protein_chain_A.itp"))

